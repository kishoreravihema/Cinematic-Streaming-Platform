<div class="music-root dark-theme">
  <header class="top-controls">
    <div class="search">
      <input type="search" placeholder="Search songs, albums, artists..." (input)="onSearchChange($event)" />
    </div>

    <div class="filters">
      <select (change)="onSelectChange($event, 'album')">
        <option value="">All Albums</option>
        <option *ngFor="let album of albums" [value]="album.id">{{ album.title }}</option>
      </select>

      <select (change)="onSelectChange($event, 'artist')">
        <option value="">All Artists</option>
        <option *ngFor="let artist of artists" [value]="artist.id">{{ artist.name }}</option>
      </select>

      <select (change)="onSelectChange($event, 'genre')">
        <option value="">All Genres</option>
        <option *ngFor="let genre of genres" [value]="genre.name">{{ genre.name }}</option>
      </select>
    </div>
  </header>

  <main class="content-grid">
    <section class="list-column">
      <div class="list-header">
        <h2>Tracks</h2>
        <div class="page-controls">
          <button (click)="prevPage()" [disabled]="musicPage <= 1">Prev</button>
          <span>Page {{ musicPage }}</span>
          <button (click)="nextPage()">Next</button>
        </div>
      </div>

      <div *ngIf="isLoading" class="loading">Loading...</div>
      <div *ngIf="error" class="error">{{ error }}</div>

      <div class="track-cards">
        <div *ngFor="let track of playlist; let i = index"
             class="track-card"
             [class.active]="currentIndex === i"
             (click)="playTrack(i)">
          <img *ngIf="track.thumbnailUrl" [src]="track.thumbnailUrl" alt="thumb" class="thumb" />
          <div class="meta">
            <div class="title">{{ track.title }}</div>
            <div class="artist">{{ getArtistNames(track) }}</div>
            <div class="album">{{ track.album ? track.album.title : 'Unknown Album' }}</div>
          </div>

          <div class="actions">
            <button (click)="onPlayButtonClick(track, i, $event)">
              <ng-container *ngIf="!(track.sourceType === 'youtube' || track.sourceType === 'youtube-playlist'); else ytLabel">
                {{ currentIndex === i && (audioState$ | async)?.playing ? 'Pause' : 'Play' }}
              </ng-container>
              <ng-template #ytLabel>Play (YouTube)</ng-template>
            </button>
          </div>
        </div>
      </div>
    </section>

    <aside class="player-column">
      <div class="player-card" *ngIf="currentTrack$ | async as currentTrack">
        <div class="now-playing">
          <img *ngIf="currentTrack.thumbnailUrl" [src]="currentTrack.thumbnailUrl" alt="thumb" class="now-thumb" />
          <div class="titles">
            <div class="title">{{ currentTrack.title }}</div>
            <div class="artist">{{ getArtistNames(currentTrack) }}</div>
          </div>
        </div>

        <div class="player-body">
          <!-- Inline YouTube player -->
          <iframe *ngIf="currentYouTubeUrl"
                  class="video-iframe"
                  [src]="currentYouTubeUrl | safeUrl"
                  frameborder="0"
                  allow="autoplay; encrypted-media"
                  allowfullscreen>
          </iframe>

          <!-- Regular audio player -->
          <div *ngIf="!currentYouTubeUrl" class="audio-area">
            <div class="controls">
              <button (click)="previous()">&#9664;</button>
              <button (click)="togglePlayPause()">
                {{ (audioState$ | async)?.playing ? 'Pause' : 'Play' }}
              </button>
              <button (click)="next()">&#9654;</button>
            </div>

            <div class="progress">
              <input type="range"
                     [max]="(audioState$ | async)?.duration || 0"
                     [value]="(audioState$ | async)?.currentTime || 0"
                     (input)="onSeek($event)" />
            </div>

            <div class="volume">
              <button (click)="mute()">ðŸ”‡</button>
              <input type="range" min="0" max="100" (input)="onVolumeChange($event)" />
            </div>
          </div>
        </div>
      </div>
    </aside>
  </main>
</div>
